<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Books on Loan / Reserve</title>
    <style>
      body {
        font-family: Verdana, sans-serif;
        margin: 20px;
      }
      nav {
        margin-bottom: 20px;
      }
      nav a {
        margin-right: 10px;
        padding: 8px 12px;
        text-decoration: none;
        background-color: #ddd;
        color: black;
        border-radius: 4px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 10px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      #message {
        margin-top: 10px;
        color: green;
      }
    </style>
  </head>
  <body>
    <h1>Books on Loan / Reserve</h1>

    <nav>
      <a href="http://127.0.0.1:8008/member/home">All Books</a>
      <a href="http://127.0.0.1:8008/member/available">Available for Loan</a>
      <a href="http://127.0.0.1:8008/member/on-loan">Books on Loan / Reserve</a>
    </nav>

    <table id="booksTable">
      <thead>
        <tr>
          <th>ISBN</th>
          <th>Title</th>
          <th>Categories</th>
          <th>Publish Year</th>
          <th>Publisher</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="message"></div>

    <script>
      async function loadBooks() {
        const url = "/api/books/on-loan"; // API endpoint for books currently on loan
        try {
          const res = await fetch(url);
          const books = await res.json();

          const tbody = document.querySelector("#booksTable tbody");
          tbody.innerHTML = "";

          books.forEach((b) => {
            const tr = document.createElement("tr");
            const reserveBtn = `<button onclick="reserveBook('${b.ISBN}')">Reserve</button>`;
            tr.innerHTML = `
            <td>${b.ISBN}</td>
            <td>${b.Title}</td>
            <td>${b.Categories ?? ""}</td>
            <td>${b.PublishYear ?? ""}</td>
            <td>${b.PublishName ?? ""}</td>
            <td>${reserveBtn}</td>
          `;
            tbody.appendChild(tr);
          });
        } catch (err) {
          document.getElementById("message").innerText = "Error loading books.";
          console.error(err);
        }
      }

      async function reserveBook(isbn) {
        const memberID = prompt("Enter your Member ID to reserve this book:");
        if (!memberID) return;

        const today = new Date().toISOString().split("T")[0];

        try {
          const res = await fetch("/api/reservations/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              BookReserved: isbn,
              memberID: parseInt(memberID),
              DateFor: today,
            }),
          });

          if (res.ok) {
            document.getElementById("message").innerText =
              "Book reserved successfully!";
            loadBooks();
          } else {
            const err = await res.json();
            document.getElementById("message").innerText =
              "Error: " + err.detail;
          }
        } catch (error) {
          document.getElementById("message").innerText =
            "Error reserving book.";
          console.error(error);
        }
      }

      // Initial load
      loadBooks();
    </script>
  </body>
</html>
